   @Styles.Render("~/Content/css")
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section scripts
{
<script type="text/javascript">
    $(document).ready(function () {
        initCusCompanyDataGrid();
        initCus();
        initCity(null);


    });

    $(window).load(function () {
        $("#CMPID").textbox('textbox').bind('blur', function (e) {
            if ($('#CMPID').textbox("textbox").attr("readonly") != "readonly") {
                var code = $("#CMPID").textbox('getValue');
                chkCode(code);
            }
        });
     
    });


    function initCusCompanyDataGrid() {
        $('#ListDG').datagrid({
            url: '@Url.Action("getCusCompany", "CusCompany")',
            nowrap: false,
            sortName: 'CMPID',
            sortOrder: 'asc',
            remoteSort: true,
            rownumbers: true,
            border: false,
            singleSelect: true,
            striped: true,
            showPageList: true,
            pagePosition: 'bottom',
            pagination: true,
            pageSize: 20,
            pageList: [20, 50, 100],
            columns: [[
            //{ field: 'UUID', width: 40, checkbox: true },
                {field: 'CMPID', title: '統編', width: 70, sortable: true },
                { field: 'CMPNAME', title: '公司名稱', width: 150, sortable: true },
                { field: 'TEL', title: '電話', width: 110, sortable: true },
                { field: 'CUS', title: '連絡人', width: 50, sortable: true,
                    halign: "center",
                    align: "center",
                    formatter: function (value, objRow, iIndex) {
                        return "<a title='連絡人' href='/Coupon/Cus/Index?CMPID="+objRow.CMPID+"'><img src='../Content/easyui/themes/icons/user16.png' border='0'></a>";
                    }                
                }
            ]],
            onSelect: function (rowIndex, row) {
                displayForm(row);
            }
        });
    }

    function displayForm(row) {
        $('#cc').layout('panel', 'center').panel('setTitle', '編輯');
        $('#CMPID').textbox('setValue', row.CMPID);
        
        $('#CMPID').textbox('readonly', true);
        //$('#CMPID').textbox('disable');
        $('#CMPNAME').val(row.CMPNAME);
        $('#TEL').val(row.TEL);
        $('#FAX').val(row.FAX);
        $('#EMAIL').val(row.EMAIL);
        $('#UUID').val(row.UUID);
        $('#ADDR').val(row.ADDR);
        $('#CMPNAME').validatebox('validate');
        initCity(row.ZIP);
        $('#divCode').html('');

        var obj = {};
        obj.CMPID = row.CMPID;        
        $('#CusDG').datagrid('reload', obj);
    }


    function initCity(ZIP){
        $('#CITY').combobox({
            url: '@Url.Action("getCityList", "CusCompany")',
            valueField: 'CODE',
            textField: 'NAME',
            onSelect: function (record) {
                initZIP(null, record.NAME);                
                 $('#ADDR').val(record.NAME);                
            },
            onLoadSuccess: function () {
                if (ZIP != null) {
                    var obj = {};
                    obj.ZIP = ZIP;
                    $.ajax({
                        url: '@Url.Action("getCity", "CusCompany")',
                        type: "post",
                        data: obj,
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            $('#CITY').combobox('setValue', data[0].NAME);
                            initZIP(ZIP, data[0].NAME);
                        }
                    });
                } else {
                    initZIP(null, null);
                }
            }
        });

    }

    function initZIP(ZIP, NAME) {      
        $('#ZIP').combobox({
            url: '@Url.Action("getZIPList", "CusCompany")',
            valueField: 'CODE',
            textField: 'NAME',
            onSelect: function (record) {
                initZIP(null, record.NAME);
            },
            onBeforeLoad: function (param) {
                param.NAME = NAME;
            },
            onLoadSuccess: function () {
                if (ZIP != null) {
                    var obj = {};
                    obj.ZIP = ZIP;
                    $.ajax({
                        url: '@Url.Action("getZIP", "CusCompany")',
                        type: "post",
                        data: obj,
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {                            
                            $('#ZIP').combobox('setValue', data[0].CODE);
                        }
                    });
                }
            }
        });
    }

    function doAdd() {
        $('#CMPID').textbox('readonly', false);
        $('#cc').layout('panel', 'center').panel('setTitle', '新增');
        $('#ff').form('clear');
        
    }


    function doSave() {
        $('#ff').form('submit', {
            url: '@Url.Action("doSave", "CusCompany")',
            onSubmit: function () {
                return $(this).form('enableValidation').form('validate');
            },
            success: function (data) {                
                if (data.result != "0") {
                    $.messager.alert('系統訊息', '資料儲存完成!', 'info');
                    $('#ListDG').datagrid('reload');
                }
            }
        });       
    }

    function doDelete() {
        var row = $('#ListDG').datagrid('getSelected');
        if (row != null) {
            $.messager.confirm('系統訊息', '確定刪除 '+row.CMPNAME+' 資料?', function (r) {
                if (r) {
                    var obj = {};
                    obj.UUID = row.UUID;
                    $.ajax({
                        url: '@Url.Action("doDelete", "CusCompany")',
                        type: "post",
                        data: obj,
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.result != "0") {
                                $.messager.alert('系統訊息', '資料已刪除!', 'info');
                                doAdd();
                                $('#ListDG').datagrid('reload');
                            }
                        }
                    });
                }
            });
        } else {
            $.messager.alert('系統訊息', '尚未選擇資料!', 'warning');
        }  
    }


    function chkCode(code) {
    
        $.messager.progress({text: '檢查中,請稍後...'});       
        var obj = {};
        obj.CMPID = code;
        $.ajax({
            url: '@Url.Action("chkCode", "CusCompany")',
            type: "post",
            data: obj,
            dataType: "json",
            async: false,
            success: function (data, textStatus, jqXHR) {                
                $.messager.progress('close');
                if (data != "0") {
                    $('#divCode').html('代碼 ' + code + ' 已存在,請重新輸入!');
                    $('#CMPID').textbox('setValue', '');
                    return false;
                } else {
                    $('#divCode').html('');
                }

            }
        });
    }



    function getCus(CMPID) {
        //console.info('@Url.Action("Index", "Coupon/Cus")' + "?cmpid=" + CMPID);
        location.href = '@Url.Action("Index", "/Coupon/Cus")'+ "?cmpid="+CMPID;

    }

    function findCus() {
        var obj = {};
        obj.SEARCH = $('#SEARCH').val();
        $('#ListDG').datagrid('reload', obj);
        $('#CusDG').datagrid('reload', obj);
        $('#cc2').layout('expand', 'south');
    }



    function initCus() {
        var obj = {};
        obj.CMPID = ' ';

        $('#CusDG').datagrid({
            url: '@Url.Action("getCus", "Cus")',
            nowrap: false,
            queryParams: obj,
            sortName: 'NAME',
            sortOrder: 'asc',
            remoteSort: true,
            rownumbers: true,
            border: false,
            singleSelect: true,
            striped: true,
            showPageList: true,
            pagePosition: 'bottom',
            pagination: true,
            pageSize: 20,
            pageList: [20, 50, 100],
            columns: [[
            //{ field: 'UUID', width: 40, checkbox: true },
                {field: 'NAME', title: '姓名', width: 120, sortable: true },
                { field: 'TEL', title: '電話', width: 100, sortable: true },
                { field: 'TEL_M', title: '行動電話', width: 100, sortable: true },
                { field: 'EDIT', title: '編輯', width: 60, sortable: true,
                    halign: "center",
                    align: "center",
                    formatter: function (value, objRow, iIndex) {
                        return "<a title='編輯' href='/Coupon/Cus/Index?UUID=" + objRow.UUID + "'><img src='../Content/easyui/themes/icons/user16.png' border='0'></a>";
                    }
                }

            ]],
            onSelect: function (rowIndex, row) {
                // displayForm(row);
            },
            onLoadSuccess: function (data) {
                if (data.total > 0) {
                  //  $('#cc2').layout('expand', 'south');
                }
            }
        });
    }

</script>
}

<h2>公司客戶資料維護</h2>
 <input id="SEARCH" class="easyui-searchbox" data-options="prompt:'請輸入查詢字串',searcher:findCus" style="width:250px;height:25px">
<div id="cc" class="easyui-layout" data-options="fit:true" style="padding-bottom:17em;"  > 
    <div data-options="region:'west',title:'公司客戶列表',fitColumns:true,split:true"  style="background:#eee;width:30%; height:100%">
       <div id="cc2" class="easyui-layout" data-options="fit:true"  > 
            <div data-options="region:'center',title:''" style="height:50%;">
                <table id="ListDG"  data-options="fit:true" ></table>
            </div>
            <div data-options="region:'south',title:'個人客戶資料',split:true,collapsed:true" style="padding:5px;height:50%;">
                <table id="CusDG"  data-options="fit:true" ></table>
            </div>
        </div>
    </div>            
    <div data-options="region:'center',title:'新增'"  style="width:70%; padding:1em 1em 1em 1em" >
    <div class="easyui-panel" style="padding:5px;">
        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'add-icon'" onclick="doAdd()">新增</a>
        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'save-icon'" onclick="doSave()">儲存</a>
        <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'delete-icon'" onclick="doDelete()">刪除</a>
    </div>
   <form id="ff" method="post" >    
      <input id="UUID" name="UUID"  type="hidden" />
            <table cellpadding="5">
                <tr>
                    <td><strong>統一編號:</strong></td>
                    <td><input id="CMPID" name="CMPID" type="text" class="easyui-textbox" data-options="missingMessage:'該輸入項為必輸項'" required="required" style="width:180px;height:30px"/><div id="divCode" style="color:Red"></div></td>
                </tr>
                <tr>
                    <td><strong>公司名稱:</strong></td>
                    <td><input id="CMPNAME" name="CMPNAME"  type="text" class="easyui-validatebox" required="required" style="width:300px"/></td>
                </tr>
                <tr>
                    <td><strong>電話:</strong></td>
                    <td><input id="TEL" name="TEL" type="text" class="easyui-validatebox"  style="width:180px"/></td>
                </tr>
                <tr>
                    <td><strong>傳真:</strong></td>
                    <td><input id="FAX" name="FAX" type="text" class="easyui-validatebox" style="width:180px"/></td>
                </tr>
                <tr>
                    <td><strong>EMail:</strong></td>
                    <td><input id="EMAIL" name="EMAIL" type="text" class="easyui-validatebox" style="width:300px"/></td>
                </tr>   
                <tr>
                    <td><strong>縣市:</strong></td>
                    <td><input id="CITY" name="CITY" class="easyui-combobox" data-options="editable:false" style="width:180px;height:30px"/></td>
                </tr>                            
                <tr>
                    <td><strong>鄉鎮:</strong></td>
                    <td><input id="ZIP" name="ZIP" class="easyui-combobox" data-options="editable:false" style="width:180px;height:30px"/></td>
                </tr>                            
                <tr>
                    <td><strong>街道門牌:</strong></td>
                    <td><input id="ADDR" name="ADDR" style="width:300px"/></td>
                </tr>   
            </table>
        </form>
    </div>
</div>
