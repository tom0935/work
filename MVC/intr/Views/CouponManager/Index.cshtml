@{
    ViewBag.Title = "兌換券查詢";
}
<script src="~/Scripts/bootbox.min.js"></script>

<div id="alert_placeholder"></div>
<h4><span class="label label-primary">@ViewBag.Title</span></h4>
<script>

    var valid = false;
    var selections = [];
    $(document).ready(function () {





    });


    function doQuery() {
        $('#message').html(""); 
        if ($('#CINO').val() != "" && $('#CINO').val() != null && $('#CINO').val().length ==14) {
            var obj = {};
            obj.CINO = $('#CINO').val();
            $.ajax({
                url: '@Url.Action("doQuery", "CouponManager")',
                type: "post",
                data: JSON.stringify(obj),
                dataType: "json",
                contentType: "application/json",
                success: function (data, textStatus, jqXHR) {
                    if (data[0] != undefined) {
                        $('#message').html("申請單編號:" + data[0].ISUID + ",收券日期:" + data[0].S5DATE + ",收券單位:" + data[0].S5ENTID + ",收券人員:" + data[0].S5USERID + ",補登日期:" + data[0].XDATE + ",補登有效日期:" + data[0].XDY);
                        if (data[0].STATUS == "5") {
                            bootbox.confirm(obj.CINO + "此券號已收券,確認變更為有效券?", function (result) {
                                if (result) {
                                    console.info(data[0].ISUID);
                                    console.info(obj.CINO);
                                    doSave(data[0].ISUID, obj.CINO);
                                }
                            });
                        } else if (data[0].STATUS == "4") {
                            showalert('此筆資料為有效券!', 'alert-success');
                        } else if (data[0].STATUS == "9") {
                            showalert('此筆資料為作廢券,請與相關人員進行確認', 'alert-warning');
                        } else if (data[0].STATUS == "0") {
                            showalert('此筆資料未生效,請確認', 'alert-warning');
                        }
                    } else {
                        $('#message').html("");
                        showalert('無此券號,請確認', 'alert-warning');
                    }
                }
            });
        }
    }


    function doQuery1() {
        $('#message').html(""); 
        if ($('#COUPON_NO').val() != "" && $('#COUPON_NO').val() != null && $('#COUPON_NO').val().length == 14) {
            var obj = {};
            obj.CINO = $('#COUPON_NO').val();
            $.ajax({
                url: '@Url.Action("doQuery", "CouponManager")',
                type: "post",
                data: JSON.stringify(obj),
                dataType: "json",
                contentType: "application/json",
                success: function (data, textStatus, jqXHR) {
                    
                    if (data[0] != undefined) {
                        $('#message').html("申請單編號:" + data[0].ISUID + ",收券日期:" + data[0].S5DATE + ",收券單位:" + data[0].S5ENTID + ",收券人員:" + data[0].S5USERID + ",補登日期:" + data[0].XDATE + ",補登有效日期:" + data[0].XDY); 
                        if (data[0].XDATE == "") {
                            bootbox.confirm("確認進行補登?", function (result) {
                                if (result) {
                                    doSave1(data[0].ISUID, obj.CINO);
                                }
                            });                          
                        }
                    } else {
                        $('#message').html(""); 
                        showalert('無此券號,請確認', 'alert-warning');
                    }
                }
            });
        }
    }





    function doSave(ISUID, CINO) {
        var obj = {};
            obj.ISUID = ISUID;
            obj.CINO = CINO;
            $.ajax({
                url: '@Url.Action("doSave", "CouponManager")',
                type: "post",
                data: JSON.stringify(obj),
                dataType: "json",
                contentType: "application/json",
                success: function (data, textStatus, jqXHR) {
                    if (data.status > 0 ) {
                        showalert('資料更新完成,已恢復成有效券!', 'alert-success');
                    }                                    
                }
            });     
    }


    function doSave1(ISUID, CINO) {
        obj.ISUID = ISUID;
        obj.CINO = CINO;
        $.ajax({
            url: '@Url.Action("doSave1", "CouponManager")',
            type: "post",
            data: JSON.stringify(obj),
            dataType: "json",
            contentType: "application/json",
            success: function (data, textStatus, jqXHR) {
                if (data.status > 0) {
                    showalert('資料已完成補登錄作業!', 'alert-success');
                }
            }
        });
    }


    function showalert(message, alerttype) {
        var i = 6000;
        $("#alertdiv").remove();
        $('#alert_placeholder').append('<div id="alertdiv" class="alert ' + alerttype + '"><a class="close" data-dismiss="alert"> x </a><span>' + message + '</span></div>');
        if (alerttype == "alert-danger") {
            i = 6000   //錯誤訊息停留1分
        }
        setTimeout(function () {
            $("#alertdiv").remove();
        }, i);
    }



</script>

  <br />
  <div id="alert_placeholder"></div>
  <div id="message"></div>
   <div class="form-horizontal" >      
                    <div class="form-group">
                         <label class="control-label col-sm-2" for="CINO">誤收券恢復成有效券</label>                          
                        <div class="col-sm-8">
                                 <input type="text" class="form-control" id="CINO" maxlength="14" placeholder="請輸入要修改的兌換券編號">
                        </div>
                        <div class="col-sm-2">
                         <span class="input-group-btn">            
                            <button id="SearchBtn1" class="btn btn-success" onclick="doQuery()" >
                                <i class="glyphicon glyphicon-ok"></i>  確 認
                            </button>
                        </span>
                        </div>
                    </div>
                    <br />
                    <div class="form-group">
                         <label class="control-label col-sm-2" for="COUPON_NO">補登券異常,手動補登錄</label>                          
                        <div class="col-sm-8">
                                 <input type="text" class="form-control" id="COUPON_NO" maxlength="14" placeholder="請輸入要補登的券號">
                        </div>
                        <div class="col-sm-2">
                         <span class="input-group-btn">            
                            <button id="SearchBtn2" class="btn btn-success" onclick="doQuery1()">
                                <i class="glyphicon glyphicon-ok"></i> 確認
                            </button>
                        </span>
                        </div>
                    </div>         
</div>


