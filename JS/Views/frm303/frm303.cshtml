@{
    ViewBag.Title = "Frm303 收入預估作業";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script type="text/javascript" src="~/Content/js/util/datetime/DateTimeUtil.js"></script>
<script type="text/javascript" src="~/Content/easyui/exts/validatebox-ext.js"></script>
<script>
    $(document).ready(function () {


        //人員列表
        $('#f303LOGUSR').combobox({
            url: '@Url.Action("getLOGUSR", "Frm201h")',
            valueField: 'CNO',
            textField: 'CNM'
            //editable: false
        });


        //資訊分類
        $('#f303INFTP').combobox({
            url: '@Url.Action("getINFTP", "Frm303")',
            valueField: 'CNO',
            textField: 'CNM',
            editable: false
        });

        $('#f303YRN').combobox({
            onSelect: function (record) {
                f303DG1init();
                var obj = {};
                obj.JOBTAG = "";
                $('#f303DG2').datagrid('reload', obj);
            }
        })







    });   //ready end

    $(window).load(function () {


        //  $('#NOWDT').datebox('setValue', nowDate);
        var dt = new Date();
        var nowDate = DateTimeUtil.convertDateToISOString(dt);
        $('#f303YRN').combobox('setValue', nowDate.substr(0, 4));

        f303DG1init();
        f303DG2init();
    });


    function f303DG1init() {
        var obj = {};
        obj.yrn = $('#f303YRN').combobox('getValue');
        $('#f303DG1').datagrid({
            url: '@Url.Action("getDG1", "Frm303")',
            queryParams: obj,
            width: '600',
            height: '500',
            rownumbers: true,
            nowrap: true,
            pagination: false,
            idField: 'TAGID',
            striped: true,
            showHeader: true,
            fitColumns: false,
            remoteSort: false,
            singleSelect: true,
            columns: [[
                {
                    field: 'CNO', title: '科目代號', sortable: true, width: 100, halign: "center", align: "center", sortable: true,
                    formatter: function (value, row, iIndex) {
                        return row.TP + " " + value;
                    }
                },
                { field: 'CNM', title: '科目名稱', sortable: true, width: 230, halign: "center", align: "left", sortable: true },
                { field: 'BUDGET', title: '預算金額', sortable: true, width: 110, halign: "center", align: "right", sortable: true },
                { field: 'USEAMT', title: '動支金額', sortable: true, width: 110, halign: "center", align: "right", sortable: true }
            ]],
            onSelect: function (rowIndex, row) {
                initf303FORM(row);
            },
            onLoadSuccess: function (data) {
                $('#f303SUMAMT').val(data.tot);
            }
        });
    }


    function f303DG2init() {

        $('#f303DG2').datagrid({
            url: '@Url.Action("getDG2", "Frm303")',
            width: '300',
            height: '380',
            rownumbers: true,
            nowrap: true,
            pagination: false,
            idField: 'TAGID',
            striped: true,
            showHeader: true,
            fitColumns: false,
            remoteSort: false,
            singleSelect: true,
            columns: [[
                { field: 'YM', title: '月份', sortable: true, width: 70, halign: "center", align: "center", sortable: true },
                { field: 'BUDGET', title: '預算金額', sortable: true, width: 100, halign: "center", align: "right", sortable: true },
                { field: 'USEAMT', title: '動支金額', sortable: true, width: 100, halign: "center", align: "right", sortable: true }
            ]],
            onSelect: function (rowIndex, row) {
                initf303FORM2(row);
            }
        });
    }



    function initf303FORM(row) {
        $('#f303INFTP').combobox('setValue', $.trim(row.INFTP));
        $('#f303CNO').val($.trim(row.CNO));
        $('#f303CNM').val($.trim(row.CNM));
        $('#f303BUDGET').val($.trim(row.BUDGET));
        var obj = {};
        obj.yrn = $.trim(row.YRN);
        obj.accno = $.trim(row.CNO);
        obj.acctp = $.trim(row.TP);
        console.info(obj);
        $.ajax({
            url: '@Url.Action("getPrvYRAMT", "Frm303")',
            type: "post",
            data: obj,
            dataType: "json",
            success: function (data, textStatus, jqXHR) {
                $('#f303PRVAMT').val($.trim(data));
            }
        });

        //$('#f303PRVAMT').val($.trim(row.USEAMT));

        //$('#f303AMTSUM').validatebox('validate');
        $('#f303YRSUM').val($.trim(row.BUDGET));
        $('#f303TAGID').val($.trim(row.TAGID));
        var obj = {};
        obj.JOBTAG = $.trim(row.TAGID);
        $('#f303DG2').datagrid('reload', obj);

    }


    function initf303FORM2(row) {

        $('#f303YM').val($.trim(row.YM));
        $('#f303YMAMT').val($.trim(row.BUDGET));

    }

    function doAdd() {
        if (doCheck()) {
            $.messager.confirm('執行確認', "是否要將預算平均分攤到各月份 ?", function (r) {
                var isSplit;
                if (r) {
                    isSplit = "Y";
                } else {
                    isSplit = "N";
                }

                var obj = getObj();
                obj.isSplit = isSplit;
                obj.TAGID = null;
                $.ajax({
                    url: '@Url.Action("doAdd", "Frm303")',
                    type: "post",
                    data: getObj(),
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        if (data.status != '0') {
                            $('#f303DG1').datagrid('reload');
                            $.messager.alert('系統訊息', '資料已建立完成!', 'info');
                        }
                    }
                });
            });
        }
    }




    function doSaveYM() {
        if (doCheckYM()) {
            $.messager.confirm('執行確認', "確認儲存?", function (r) {
                if (r) {
                    var obj = getObj2();
                    $.ajax({
                        url: '@Url.Action("doSaveYM", "Frm303")',
                        type: "post",
                        data: obj,
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.status != '0') {
                                f303DG1init();
                                var obj2 = {};
                                obj2.JOBTAG = $.trim(row.TAGID);
                                $('#f303DG2').datagrid('reload', obj2);
                                $('#f303YM').val('');
                                $('#f303YMAMT').val('');
                                $.messager.alert('系統訊息', '資料已儲存!', 'info');
                            }
                        }
                    });
                }
            });
        }
    }



    function doSave() {
        if (doCheck()) {
            $.messager.confirm('執行確認', "是否確認儲存?", function (r) {
                if (r) {
                    $.messager.confirm('執行確認', "是否要將預算平均分攤到各月份", function (r) {
                        var isSplit;
                        if (r) {
                            isSplit = "Y";
                        } else {
                            isSplit = "N";
                        }
                        var obj = getObj();
                        obj.isSplit = isSplit;
                        $.ajax({
                            url: '@Url.Action("doSave", "Frm303")',
                            type: "post",
                            data: obj,
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {
                                if (data.status != '0') {
                                    $('#f303DG1').datagrid('reload');
                                    $.messager.alert('系統訊息', '資料已儲存!', 'info');
                                }
                            }
                        });
                    });
                }
                });
        }
    }

    function getObj() {
        var row = $('#f303DG1').datagrid('getSelected');
        var obj = {};
        obj.ACCNO = $.trim(row.CNO);
        obj.ACCTP = $.trim(row.TP);
        obj.YRN = $.trim($('#f303YRN').combobox('getValue'));
        obj.BUDGET = $.trim($('#f303BUDGET').val());
        obj.TAGID = $.trim($('#f303TAGID').val());
        return obj;
    }

    function getObj2() {
        var row = $('#f303DG2').datagrid('getSelected');
        var obj = {};
        obj.YMAMT = $.trim($('#f303YMAMT').val());
        obj.JOBTAG = $.trim($('#f303TAGID').val());
        obj.TAGID = $.trim(row.TAGID);
        return obj;
    }







    function doCheck() {
        var pass = false;
        var row = $('#f303DG1').datagrid('getSelected');
        if (row == null) {
            $.messager.alert('系統訊息', '尚未選取科目!', 'warning');
        }else if ($('#f303BUDGET').val() == "" ) {
            $.messager.alert('系統訊息', '資料輸入不完成!', 'warning');
        } else {
            pass = true;
        }
        return pass;
    }

    function doCheckYM() {
        var pass = false;
        if ($('#f303YM').val() == "") {
            $.messager.alert('系統訊息', '尚未選取修改月份!', 'warning');
        } else if ($('#f303YM').val() == "") {
            $.messager.alert('系統訊息', '尚未輸入調整月份金額!', 'warning');
        } else {
            pass = true;
        }
        return pass;
    }

    function doExport() {
        var obj = {};
        obj.YY = $('#f303YRN').combobox('getValue');
        window.location = "@Url.Action("doExport", "frm303")" + '?YY=' + obj.YY ;
    }




</script>
<h2>Frm303 收入預估作業</h2>
<!--<a id="btnClear" href="#" class="easyui-linkbutton" data-options="iconCls:'broom-icon'" onclick="doClear()">清空</a>-->
<!--<a id="btnCAdd" href="#" class="easyui-linkbutton" data-options="iconCls:'add-icon'" onclick="doAdd()">年度費用動支重整</a>-->
<a id="btnCSave" href="#" class="easyui-linkbutton" data-options="iconCls:'save-icon'" onclick="doSave()">科目預算存檔</a>
<a id="btnRemove" href="#" class="easyui-linkbutton" data-options="iconCls:'excel-icon'" onclick="doExport()">匯出Excel</a>
<br />
<br />
<input type="hidden" id="f303TAGID" name="f303TAGID" />
<input type="hidden" id="f303CONTRAH_TAGID" name="f303CONTRAH_TAGID" />
<input type="hidden" id="f303FEEYM" name="f303FEEYM" />
<table width="1024" border="0">
    <tr>
        <td width="350" rowspan="2">
            預算年度
            <select id="f303YRN" class="easyui-combobox" name="f303YRN" style="width:60px;height:28px">
                <option>2005</option>
                <option>2006</option>
                <option>2007</option>
                <option>2008</option>
                <option>2009</option>
                <option>2010</option>
                <option>2012</option>
                <option>2013</option>
                <option>2014</option>
                <option>2015</option>
                <option>2016</option>
                <option>2017</option>
                <option>2018</option>
                <option>2020</option>
                <option>2021</option>
                <option>2022</option>
                <option>2023</option>
                <option>2024</option>
                <option>2025</option>
                <option>2026</option>
                <option>2027</option>
                <option>2028</option>
                <option>2029</option>
                <option>2030</option>
            </select>
            費用預算總額
            <input type="text" name="f303SUMAMT" id="f303SUMAMT" style="width:100px" readonly>
        </td>
        <td>
            <a id="btnRemove" href="#" class="easyui-linkbutton" data-options="iconCls:'save-icon'" onclick="doSaveYM()">月份調整存檔</a>

        </td>
    </tr>
    <tr>
        <td >
            科目代號
            <input type="text" name="f303CNO" id="f303CNO" readonly >
        </td>
    </tr>
    <tr>
        <td rowspan="4" valign="top">
            <table id="f303DG1"></table>
        </td>

        <td>
            科目名稱
            <input type="text" name="f303CNM" id="f303CNM" style="width:200px" readonly >
        </td>
    </tr>
    <tr>
        <td>
            預算金額
            <input type="text" name="f303BUDGET" id="f303BUDGET">
        </td>
    </tr>
    <tr>
        <td>
            去年預算
            <input type="text" name="f303PRVAMT" id="f303PRVAMT" readonly>
        </td>
    </tr>
    <tr>
        <td height="700" valign="top">

            <table id="f303DG2"></table>
            <table width="100%" border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td>
                        調整月份
                        <input type="text" name="f303YM" id="f303YM" readonly style="width:70px">
                        <input type="text" name="f303YMAMT" id="f303YMAMT" style="width:70px">
                    </td>
                </tr>
                <tr>
                    <td>
                        年度合計
                        <input type="text" name="f303YRSUM" id="f303YRSUM" style="width:80px">
                        預算差異
                        <input type="text" name="f303YRDIF" id="f303YRDIF" style="width:80px" value="0">
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>